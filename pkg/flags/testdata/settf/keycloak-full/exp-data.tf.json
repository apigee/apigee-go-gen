{
  "resource": [
    {
      "google_compute_router": {
        "router": {
          "name": "nat-router",
          "network": "${var.vpc_name}",
          "project": "${var.gcp_project_id}",
          "region": "${var.gcp_region}"
        }
      }
    },
    {
      "google_compute_router_nat": {
        "nat": {
          "depends_on": [
            "google_compute_router.router"
          ],
          "log_config": {
            "enable": true,
            "filter": "ERRORS_ONLY"
          },
          "name": "my-router-nat",
          "nat_ip_allocate_option": "AUTO_ONLY",
          "region": "${var.gcp_region}",
          "router": "${google_compute_router.router.name}",
          "source_subnetwork_ip_ranges_to_nat": "ALL_SUBNETWORKS_ALL_IP_RANGES"
        }
      }
    },
    {
      "google_compute_address": {
        "keycloak_ip": {
          "address_type": "INTERNAL",
          "name": "keycloak-idp-instance-ip",
          "project": "${var.gcp_project_id}",
          "region": "${var.gcp_region}",
          "subnetwork": "${var.vpc_subnet}"
        }
      }
    },
    {
      "google_compute_instance": {
        "keycloak-idp": {
          "allow_stopping_for_update": true,
          "boot_disk": {
            "initialize_params": {
              "image": "ubuntu-os-cloud/ubuntu-2204-jammy-v20231030"
            }
          },
          "depends_on": [
            "google_compute_router_nat.nat"
          ],
          "machine_type": "e2-medium",
          "metadata_startup_script": "${templatefile(\"./startup.sh\", {keycloak_admin  = var.keycloak_admin, keycloak_admin_password = var.keycloak_admin_password})}",
          "name": "keycloak-idp-instance",
          "network_interface": {
            "network": "${var.vpc_name}",
            "network_ip": "${google_compute_address.keycloak_ip.address}",
            "subnetwork": "${var.vpc_subnet}"
          },
          "tags": [
            "keycloak-idp-instance",
            "https-server",
            "http-server"
          ]
        }
      }
    },
    {
      "google_compute_network_endpoint_group": {
        "neg": {
          "default_port": "8080",
          "name": "keycloak-instance-neg",
          "network": "${var.vpc_name}",
          "network_endpoint_type": "GCE_VM_IP_PORT",
          "subnetwork": "${var.vpc_subnet}",
          "zone": "${var.gcp_zone}"
        }
      }
    },
    {
      "google_compute_network_endpoint": {
        "keycloak-endpoint": {
          "depends_on": [
            "google_compute_instance.keycloak-idp",
            "google_compute_network_endpoint_group.neg",
            "google_compute_address.keycloak_ip"
          ],
          "instance": "${google_compute_instance.keycloak-idp.name}",
          "ip_address": "${google_compute_address.keycloak_ip.address}",
          "network_endpoint_group": "${google_compute_network_endpoint_group.neg.name}",
          "port": "${google_compute_network_endpoint_group.neg.default_port}"
        }
      }
    },
    {
      "google_compute_global_address": {
        "keycloak-idp-external-ip": {
          "name": "keycloak-idp-external-ip"
        }
      }
    },
    {
      "google_compute_managed_ssl_certificate": {
        "keycloak-idp-cert": {
          "managed": {
            "domains": [
              "${google_compute_global_address.keycloak-idp-external-ip.address}.sslip.io",
              "${google_compute_global_address.keycloak-idp-external-ip.address}.nip.io"
            ]
          },
          "name": "keycloak-idp-cert"
        }
      }
    },
    {
      "google_compute_health_check": {
        "keycloak-idp-instance-healthcheck": {
          "check_interval_sec": 1,
          "name": "keycloak-idp-instance-healthcheck",
          "tcp_health_check": {
            "port": "8080"
          },
          "timeout_sec": 1
        }
      }
    },
    {
      "google_compute_backend_service": {
        "keycloak-idp-instance-backend-service": {
          "backend": {
            "balancing_mode": "RATE",
            "group": "${google_compute_network_endpoint_group.neg.id}",
            "max_rate": 100
          },
          "depends_on": [
            "google_compute_health_check.keycloak-idp-instance-healthcheck",
            "google_compute_network_endpoint_group.neg"
          ],
          "health_checks": [
            "${google_compute_health_check.keycloak-idp-instance-healthcheck.id}"
          ],
          "name": "keycloak-idp-instance-backend-service",
          "protocol": "HTTP",
          "timeout_sec": 10
        }
      }
    },
    {
      "google_compute_url_map": {
        "keycloak-idp-lb": {
          "default_service": "${google_compute_backend_service.keycloak-idp-instance-backend-service.id}",
          "depends_on": [
            "google_compute_backend_service.keycloak-idp-instance-backend-service"
          ],
          "name": "keycloak-idp-lb"
        }
      }
    },
    {
      "google_compute_target_https_proxy": {
        "keycloak-idp-lb-proxy": {
          "depends_on": [
            "google_compute_url_map.keycloak-idp-lb"
          ],
          "name": "keycloak-idp-lb-proxy",
          "ssl_certificates": [
            "${google_compute_managed_ssl_certificate.keycloak-idp-cert.id}"
          ],
          "url_map": "${google_compute_url_map.keycloak-idp-lb.id}"
        }
      }
    },
    {
      "google_compute_global_forwarding_rule": {
        "keycloak-idp-instance-fwd-rule": {
          "depends_on": [
            "google_compute_global_address.keycloak-idp-external-ip",
            "google_compute_target_https_proxy.keycloak-idp-lb-proxy"
          ],
          "ip_address": "${google_compute_global_address.keycloak-idp-external-ip.id}",
          "name": "keycloak-idp-instance-fwd-rule",
          "port_range": 443,
          "target": "${google_compute_target_https_proxy.keycloak-idp-lb-proxy.id}"
        }
      }
    },
    {
      "google_compute_firewall": {
        "allow-keycloak-idp-healthcheck": {
          "allow": {
            "ports": [
              "8080"
            ],
            "protocol": "tcp"
          },
          "direction": "INGRESS",
          "name": "allow-keycloak-idp-healthcheck",
          "network": "${var.vpc_name}",
          "source_ranges": [
            "35.191.0.0/16",
            "130.211.0.0/22"
          ],
          "target_tags": [
            "keycloak-idp-instance"
          ]
        }
      }
    }
  ]
}