#  Copyright 2025 Google LLC
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#       http:#www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
APIProxy:
  .revision: 1
  .name: httpbin
Policies:
  - RaiseFault:
      .name: RF-InvalidCred
      DisplayName: RF-InvalidCred
      FaultResponse:
        Set:
          - StatusCode: 401
          - ReasonPhrase: Unauthorized
          - Payload:
              .contentType: application/json
              -Data: '{"error": "Unauthorized", "message": "Invalid access token"}'
          - Headers:
              Header:
                .name: Content-Type
                -Data: application/json
  - Javascript:
      .name: JS-combine-resp
      .timeLimit: 200
      .languageVersion: VERSION_ES6
      DisplayName: JS-combine-resp
      Source: |
        // Access a variable from the flow
        var myVariable = context.getVariable("myFlowVariable");

        // Set a new variable
        context.setVariable("javascript.policy.executed", true);
        
        print("JS-combine-resp policy executed!");
  - SanitizeModelResponse:
      .name: SMR-ModelResp
      DisplayName: SMR-ModelResp
      ModelArmor:
        TemplateName: projects/{organization.name}/locations/{system.region.name}/templates/default-template
      UserPromptSource: request.content
      LLMResponseSource: response.content
ProxyEndpoints:
  - ProxyEndpoint:
      .name: default
      EventFlow:
        .name: EF-1
        .content-type: text/event-stream
        Response:
          - Step:
              Name: RF-InvalidCred
              Condition: fault.name equals "invalid_access_token"
      HTTPProxyConnection:
        BasePath: /httpbin
      RouteRule:
        .name: default
        TargetEndpoint: default
TargetEndpoints:
  - TargetEndpoint:
      .name: default
      EventFlow:
        .name: EventFlow
        .content-type: text/event-stream
        Response:
          - Step:
              Name: JS-combine-resp
          - Step:
              Condition: buff_ready = true
              Name: SMR-ModelResp
      HTTPTargetConnection:
        URL: https://httpbin.org/
