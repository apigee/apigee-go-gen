#  Copyright 2025 Google LLC
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#       http:#www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

APIProxy:
  .revision: 1
  .name: {{ slug_make ($.Values.spec | dig "info" "x-serviceName" $.Values.spec.info.title) }}
  DisplayName: {{ $.Values.spec.info.title }}
  Description: |-
    {{ $.Values.spec.info.description | nindent 4 }}
Policies:
  - Javascript:
      .async: false
      .continueOnError: false
      .enabled: true
      .timeLimit: 30000
      .name: JS-MockResponse
      DisplayName: JS-MockResponse
      ResourceURL: jsc://response-mocker.cjs
  - AssignMessage:
      .continueOnError: false
      .enabled: true
      .name: AM-SaveReq
      DisplayName: AM-SaveReq
      Properties: { }
      Copy:
        .source: request
        Headers: { }
        QueryParams: { }
        FormParams: { }
        Payload: true
        Verb: true
        Path: true
      IgnoreUnresolvedVariables: true
      AssignTo:
        .createNew: true
        .transport: http
        .type: request
        -Data: original_request
  #{{- if $.Values.vertex.enabled }}
  - AssignMessage:
      .name: AM-Generate-Vertex-Token
      DisplayName: AM-Generate-Vertex-Token
      AssignTo:
        .createNew: true
        .type: request
        -Data: vertexTokenRequest
      Set:
        Authentication:
          GoogleAccessToken:
            Scopes:
              Scope: https://www.googleapis.com/auth/cloud-platform
  #{{- end }}
  - OASValidation:
      .continueOnError: false
      .enabled: true
      .name: OAS-Validate
      DisplayName: OAS-Validate
      Source: request
      OASResource: oas://openapi.json
  - AssignMessage:
      .name: AM-Config
      -Data:
        - AssignVariable:
            Name: spec_json
            ResourceURL: oas://openapi.json
      #{{- if $.Values.vertex.enabled }}
        - AssignVariable:
            Name: vertex_enabled
            Value: true
        - AssignVariable:
            Name: vertex_region
            Value: {{ $.Values.vertex.region | default "us-central1" }}
        - AssignVariable:
            Name: vertex_model
            Value: {{ $.Values.vertex.model | default "gemini-2.5-flash" }}
        - AssignVariable:
            Name: vertex_project_id
            Value: {{ $.Values.vertex.project_id | default "" }}
      #{{- else if $.Values.gemini.enabled }}
        - AssignVariable:
            Name: gemini_enabled
            Value: true
        - AssignVariable:
            Name: gemini_model
            Value: {{ $.Values.gemini.model | default "gemini-2.5-flash" }}
        - AssignVariable:
            Name: gemini_api_key
            Value: {{ $.Values.gemini.api_key }}
      #{{- end }}
  - AssignMessage:
      .continueOnError: false
      .enabled: true
      .name: AM-SetError
      DisplayName: AM-SetError
      Properties: {}
      Set:
        Payload:
          .contentType: application/json
          -Data: |-
            {
              "error": "{escapeJSON(error.message)}"
            }
        StatusCode: '{error.status.code}'
        ReasonPhrase: '{error.reason.phrase}'
  - CORS:
      .continueOnError: false
      .enabled: true
      .name: CORS-Allow
      DisplayName: CORS-Allow
      AllowOrigins: '{request.header.origin}'
      AllowMethods: GET, PUT, POST, DELETE, OPTIONS
      AllowHeaders: '*'
      ExposeHeaders: '*'
      MaxAge: 3628800
      AllowCredentials: true
      GeneratePreflightResponse: true
      IgnoreUnresolvedVariables: true
ProxyEndpoints:
  - ProxyEndpoint:
      .name: default
      DefaultFaultRule:
        .name: default-fault
        Step:
          Name: AM-SetError
      PreFlow:
        .name: PreFlow
        Request:
          - Step:
              Name: AM-SaveReq
          - Step:
              Name: CORS-Allow
          - Step:
              Condition: request.header.mock-validate-request != "false"
              Name: OAS-Validate
          - Step:
              Name: AM-Config
        Response:
          #{{- if $.Values.vertex.enabled }}
          - Step:
              Name: AM-Generate-Vertex-Token
          #{{- end }}
          - Step:
              Name: JS-MockResponse
      Flows: []
      HTTPProxyConnection:
        BasePath: {{ include "get_basepath" (index $.Values.spec.servers 0 "url") }}
      RouteRule:
        .name: no-route
TargetEndpoints: []
Resources:
  #{{ os_writefile "./openapi.json" ($.Values.spec | toPrettyJson) }}
  #{{ remove_oas_extensions "./openapi.json" }}
  #{{ remove_oas_schema_extensions "./openapi.json" }}
  - Resource:
      Type: oas
      Path: ./openapi.json
  #{{ os_copyfile "./response-mocker.cjs" "./response-mocker.cjs" }}
  - Resource:
      Type: jsc
      Path: ./response-mocker.cjs