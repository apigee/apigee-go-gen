APIProxy:
  .revision: 1
  .name: {{ slug_make ($.Values.spec | dig "info" "x-serviceName" $.Values.spec.info.title) }}
  DisplayName: {{ $.Values.spec.info.title }}
  Description: {{ $.Values.spec.info.description }}
Policies:
  #{{- os_copyfile "./policies.yaml" "./policies.yaml" | blank }}
  $ref: ./policies.yaml#/
ProxyEndpoints:
  - ProxyEndpoint:
      .name: default
      PreFlow:
        .name: PreFlow
        Request:
          - Step:
              Name: OAS-Validate
      Flows:
      #{{- range $path, $pathItem := $.Values.spec.paths }}
        #{{- range $verb, $opItem := $pathItem }}
          #{{- if eq (include "get_visibility" $opItem) "INTERNAL" }}
              #{{- fmt_printf "Skipping internal operation '%s' (%s %s)\n" $opItem.operationId $verb $path }}
              #{{-  continue }}
          #{{-  end  }}
        - Flow:
            .name: {{ $opItem.operationId }}
            Condition: (proxy.pathsuffix MatchesPath "{{  regexReplaceAll "{[^}]*}" $path "*" }}") and (request.verb = "{{ $verb | upper }}")
        #{{- end }}
      #{{- end }}
        - Flow:
            .name: CatchAll
            Request:
              - Step:
                  Name: RF-CatchAll
      HTTPProxyConnection:
        BasePath: {{ include "get_basepath" (index $.Values.spec.servers 0 "url") }}
      RouteRule:
        .name: default
        TargetEndpoint: default
TargetEndpoints:
  - TargetEndpoint:
      .name: default
      HTTPTargetConnection:
        #{{- $scheme := include "get_scheme" (index $.Values.spec.servers 0 "url") }}
        #{{- if eq $scheme "https" }}
        SSLInfo:
          Enabled: true
          Enforce: true
          IgnoreValidationErrors: true
        #{{- end }}
        URL: {{ include "get_target_url" $.Values.spec.servers }}
Resources:
  - Resource:
      Type: oas
      Path: {{ os_writefile "./spec.yaml" $.Values.spec_string }}
  - Resource:
      Type: properties
      Path: {{ os_copyfile "./test.properties" "./resources/test.properties" }}
