# OpenAPI 3 Golden Structure
<!--
  Copyright 2024 Google LLC

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

This template directory (work in progress) contains the golden structure that Apigee recommends
to use as best practice to generate API Proxies and related configuration files.


## Structure

* apiproxy.yaml - This is the main template file from which the API Proxy bundle zip is generated
* target-server.yaml - This is the template file for generating an Apigee target server config file


## API Proxy Template

This template contains all the information needed to create the Apigee API proxy bundle zip file.

Below is an example to generate the bundle

```shell
apigee-go-gen render apiproxy \
    --template ./examples/templates/oas3-golden/apiproxy.yaml \
    --include ./examples/templates/oas3-golden/*.tmpl \
    --set-oas spec=./examples/specs/oas3/petstore.yaml \
    --output ./out/apiproxies/petstore.zip
```

Which will create the `petstore.zip` bundle.

>Alternatively, you can omit the `.zip` extension and it will create a directory instead.

## Target Server Template

The target server configuration is generated by choosing a server from the list of `servers` in the OpenAPI spec.
The chosen server depends on the specified `env` value that is passed to the rendering process using `--set-string env=foo`

See examples below:

### Target server for prod

```shell
apigee-go-gen render template \
   --template ./examples/templates/oas3/target-server.yaml \
   --set-oas spec=./examples/specs/oas3/petstore.yaml \
   --set-string env=prod \
   --include ./examples/templates/oas3/*.tmpl \
   --dry-run true  | apigee-go-gen transform yaml-to-json
```

produces 

```json
{
  "name": "TS-swagger-petstore",
  "host": "petstore.swagger.io",
  "isEnabled": true,
  "port": 443,
  "sSLInfo": {
    "clientAuthEnabled": "false",
    "enabled": "true",
    "ignoreValidationErrors": "false"
  }
}
```

### Target Server for stage
```shell
apigee-go-gen render template \
   --template ./examples/templates/oas3/target-server.yaml \
   --set-oas spec=./examples/specs/oas3/petstore.yaml \
   --set-string env=prod \
   --include ./examples/templates/oas3/*.tmpl \
   --dry-run true  | apigee-go-gen transform yaml-to-json
```

produces
```json
{
  "name": "TS-swagger-petstore",
  "host": "stage-petstore.swagger.io",
  "isEnabled": true,
  "port": 8443,
  "sSLInfo": {
    "clientAuthEnabled": "false",
    "enabled": "true",
    "ignoreValidationErrors": "false"
  }
}
```

### Target Server for dev

```shell
apigee-go-gen render template \
   --template ./examples/templates/oas3-golden/target-server.yaml \
   --include ./examples/templates/oas3-golden/*.tmpl \
   --set-oas spec=./examples/specs/oas3/petstore.yaml \
   --set-string env=dev \
   --dry-run true  | apigee-go-gen transform yaml-to-json
```

produces

```json
{
  "name": "TS-swagger-petstore",
  "host": "dev-petstore.swagger.io",
  "isEnabled": true,
  "port": 80
}
```